<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мои 1–3 цели</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 820px; margin: 24px auto; padding: 0 16px; }
    textarea, input { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .row { display: grid; gap: 10px; margin-bottom: 12px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .muted { color: #666; font-size: 14px; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 14px 0; }
    .flex { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  </style>
</head>
<body>
  <h1>1–3 главные цели</h1>
  <p class="muted">Данные сохраняются на этом устройстве. Если не открывать страницу 48 часов — всё удалится.</p>

  <div class="box">
    <div class="row">
      <label>Цель 1</label>
      <input id="g1" placeholder="Например: Плавать 3 раза в неделю" />
    </div>
    <div class="row">
      <label>Цель 2</label>
      <input id="g2" placeholder="Например: Делать зарядку 10 минут" />
    </div>
    <div class="row">
      <label>Цель 3</label>
      <input id="g3" placeholder="Например: 1 час фокус-работы" />
    </div>

    <div class="row">
      <label>Сегодняшняя отметка / дневник</label>
      <textarea id="log" rows="6" placeholder="Что сделал сегодня по целям?"></textarea>
    </div>

    <div class="flex">
      <button id="save">Сохранить</button>
      <button id="clear">Удалить всё</button>
      <span class="muted" id="status"></span>
    </div>
  </div>

  <div class="box">
    <h3>История (последние записи)</h3>
    <div id="history" class="muted"></div>
  </div>

<script>
  const KEY = "goals_app_v1";
  const TTL_MS = 48 * 60 * 60 * 1000; // 48 часов

  const el = (id) => document.getElementById(id);

  function now() { return Date.now(); }

  function loadState() {
    const raw = localStorage.getItem(KEY);
    return raw ? JSON.parse(raw) : null;
  }

  function saveState(state) {
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function clearState() {
    localStorage.removeItem(KEY);
  }

  function expired(state) {
    if (!state?.lastOpenAt) return false;
    return (now() - state.lastOpenAt) > TTL_MS;
  }

  function render(state) {
    el("g1").value = state?.goals?.[0] ?? "";
    el("g2").value = state?.goals?.[1] ?? "";
    el("g3").value = state?.goals?.[2] ?? "";
    el("log").value = "";

    const hist = (state?.entries ?? []).slice().reverse().slice(0, 10);
    el("history").innerHTML = hist.length
      ? hist.map(e => `<div style="margin:8px 0;"><b>${new Date(e.at).toLocaleString()}</b><br>${escapeHtml(e.text)}</div>`).join("")
      : "Пока записей нет.";
  }

  function escapeHtml(s) {
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  // При открытии: проверить истечение и обновить lastOpenAt
  let state = loadState();
  if (state && expired(state)) {
    clearState();
    state = null;
  }
  state = state ?? { goals: ["","",""], entries: [], lastOpenAt: now() };
  state.lastOpenAt = now();
  saveState(state);
  render(state);

  el("status").textContent = "Последний визит обновлён: " + new Date(state.lastOpenAt).toLocaleString();

  el("save").addEventListener("click", () => {
    const goals = [el("g1").value.trim(), el("g2").value.trim(), el("g3").value.trim()];
    const text = el("log").value.trim();

    state.goals = goals;
    if (text) state.entries.push({ at: now(), text });
    state.lastOpenAt = now();

    saveState(state);
    render(state);
    el("status").textContent = "Сохранено: " + new Date(state.lastOpenAt).toLocaleString();
  });

  el("clear").addEventListener("click", () => {
    clearState();
    state = { goals: ["","",""], entries: [], lastOpenAt: now() };
    saveState(state);
    render(state);
    el("status").textContent = "Удалено.";
  });
</script>
</body>
</html>
